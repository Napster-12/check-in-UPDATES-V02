{% extends 'base.html' %}
{% block content %}
<style>
  body {
    background-color: #f4f6f8;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #1f2937;
    margin: 0;
    padding: 0;
  }

  .dashboard {
    padding: 40px;
    max-width: 1400px;
    margin: auto;
  }

  .title {
    text-align: center;
    margin-bottom: 40px;
    font-size: 2rem;
    font-weight: 600;
    color: #1f2937;
  }

  /* Filters */
  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 40px;
    justify-content: center;
  }

  .filters select {
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    background-color: #ffffff;
    color: #1f2937;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .filters select:hover {
    border-color: #3b82f6;
  }

  /* KPI Cards */
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .card {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  }

  .card h3 {
    font-size: 2rem;
    color: #3b82f6;
    margin-bottom: 10px;
  }

  .card p {
    font-size: 1rem;
    color: #475569;
  }

  /* Charts */
  .charts {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }

  .chart-container {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    flex: 1 1 300px;
    max-width: 400px;
    min-width: 300px;
  }

  .chart-container canvas {
    max-height: 250px;
  }

  .chart-title {
    font-size: 1.1rem;
    font-weight: 500;
    color: #1f2937;
    margin-bottom: 10px;
    text-align: center;
  }

  @media(max-width: 1024px) {
    .charts {
      flex-direction: column;
      align-items: center;
    }
  }
</style>

<div class="dashboard">
  <h2 class="title">ðŸ“Š WIL Coordinator Dashboard</h2>

  <!-- Filters -->
  <div class="filters">
    <select id="mentorFilter">
      <option value="all">All Mentors</option>
    </select>

    <select id="studentFilter">
      <option value="all">All Students</option>
    </select>

    <select id="institutionFilter">
      <option value="all">All Institutions</option>
    </select>

    <select id="monthFilter">
      <option value="all">All Months</option>
      <option value="1">January</option><option value="2">February</option>
      <option value="3">March</option><option value="4">April</option>
      <option value="5">May</option><option value="6">June</option>
      <option value="7">July</option><option value="8">August</option>
      <option value="9">September</option><option value="10">October</option>
      <option value="11">November</option><option value="12">December</option>
    </select>

    <select id="yearFilter">
      <option value="all">All Years</option>
      <option value="2024">2024</option>
      <option value="2025">2025</option>
    </select>
  </div>

  <!-- KPI Cards -->
  <div class="stats">
    <div class="card"><h3 id="mentorCount">0</h3><p>Total Mentors</p></div>
    <div class="card"><h3 id="studentCount">0</h3><p>Total Students</p></div>
    <div class="card"><h3 id="institutionCount">0</h3><p>Partner Institutions</p></div>
    <div class="card"><h3 id="checkInCount">0</h3><p>Total Check-Ins</p></div>
    <div class="card"><h3 id="assignmentCount">0</h3><p>Total Assignments</p></div>
  </div>

  <!-- Charts aligned horizontally -->
  <div class="charts">
    <div class="chart-container">
      <div class="chart-title">Students per Mentor</div>
      <canvas id="mentorChart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Students per Institution</div>
      <canvas id="institutionChart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Department vs Number of Students</div>
      <canvas id="departmentChart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const users = {{ users|default([])|tojson }};
const students = {{ students|default([])|tojson }};
const assignmentCounts = {{ assignment_counts|default({})|tojson }};

// Filter elements
const mentorFilter = document.getElementById('mentorFilter');
const studentFilter = document.getElementById('studentFilter');
const institutionFilter = document.getElementById('institutionFilter');
const monthFilter = document.getElementById('monthFilter');
const yearFilter = document.getElementById('yearFilter');

// Populate mentor filter
users.filter(u => u.role.toLowerCase() === 'mentor').forEach(u => {
  const opt = document.createElement('option');
  opt.value = u.id;
  opt.textContent = u.fullname;
  mentorFilter.appendChild(opt);
});

// Populate institution filter
[...new Set(students.map(s => s.organization))].forEach(inst => {
  const opt = document.createElement('option');
  opt.value = inst;
  opt.textContent = inst;
  institutionFilter.appendChild(opt);
});

let mentorChart, institutionChart, departmentChart;

function renderCharts(filteredStudents){
  if(mentorChart) mentorChart.destroy();
  if(institutionChart) institutionChart.destroy();
  if(departmentChart) departmentChart.destroy();

  // Students per Mentor
  const mentorCounts = {};
  filteredStudents.forEach(s => {
    const mentorName = users.find(u => u.id === s.mentor_id)?.fullname || 'Unknown';
    mentorCounts[mentorName] = (mentorCounts[mentorName] || 0) + 1;
  });

  // Students per Institution
  const institutionCounts = {};
  filteredStudents.forEach(s => {
    institutionCounts[s.organization] = (institutionCounts[s.organization] || 0) + 1;
  });

  // Department vs Number of Students
  const deptCounts = {};
  filteredStudents.forEach(s => {
    deptCounts[s.department] = (deptCounts[s.department] || 0) + 1;
  });

  // Update KPI cards
  document.getElementById('mentorCount').textContent = users.filter(u => u.role.toLowerCase() === 'mentor').length;
  document.getElementById('studentCount').textContent = filteredStudents.length;
  document.getElementById('institutionCount').textContent = Object.keys(institutionCounts).length;
  document.getElementById('checkInCount').textContent = filteredStudents.reduce((sum,s) => sum + (s.checkins?.length || 0), 0);
  document.getElementById('assignmentCount').textContent = filteredStudents.reduce((sum,s) => sum + (assignmentCounts[s.id] || 0), 0);

  // Render charts
  mentorChart = new Chart(document.getElementById('mentorChart'), {
    type:'bar',
    data:{ labels:Object.keys(mentorCounts), datasets:[{label:'Students per Mentor', data:Object.values(mentorCounts), backgroundColor:'#3b82f6'}] },
    options:{ scales:{ y:{ beginAtZero:true } } }
  });

  institutionChart = new Chart(document.getElementById('institutionChart'), {
    type:'doughnut',
    data:{ labels:Object.keys(institutionCounts), datasets:[{data:Object.values(institutionCounts), backgroundColor:['#3b82f6','#f59e0b','#10b981']}] }
  });

  departmentChart = new Chart(document.getElementById('departmentChart'), {
    type:'bar',
    data:{ labels:Object.keys(deptCounts), datasets:[{label:'Students per Department', data:Object.values(deptCounts), backgroundColor:'#f59e0b'}] },
    options:{ scales:{ y:{ beginAtZero:true } } }
  });
}

function applyFilters(){
  let filtered = [...students];
  const mentorVal = mentorFilter.value;
  const instVal = institutionFilter.value;
  const studentVal = studentFilter.value;
  const monthVal = monthFilter.value;
  const yearVal = yearFilter.value;

  if(mentorVal !== 'all') filtered = filtered.filter(s => s.mentor_id == mentorVal);
  if(instVal !== 'all') filtered = filtered.filter(s => s.organization === instVal);
  if(studentVal !== 'all') filtered = filtered.filter(s => s.id == studentVal);
  if(monthVal !== 'all') filtered = filtered.filter(s => s.checkins?.some(c => new Date(c.timestamp).getMonth()+1 == monthVal));
  if(yearVal !== 'all') filtered = filtered.filter(s => s.checkins?.some(c => new Date(c.timestamp).getFullYear() == yearVal));

  // Update student filter dynamically
  studentFilter.innerHTML = '<option value="all">All Students</option>';
  filtered.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.fullname;
    studentFilter.appendChild(opt);
  });

  renderCharts(filtered);
}

// Event listeners for all filters
[mentorFilter, studentFilter, institutionFilter, monthFilter, yearFilter].forEach(sel => sel.addEventListener('change', applyFilters));

// Initial render
renderCharts(students);
</script>


{% endblock %}
